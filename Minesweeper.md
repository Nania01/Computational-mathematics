## Игра "Сапёр" (Minesweeper)

### Определение
**«Сапёр»** (англ. *Minesweeper*) – это логическая игра на прямоугольной решётке, в каждой клетке которой может находиться либо мина, либо пустое место. Игрок открывает клетки, стараясь не попасть на мину, и использует числовые подсказки, чтобы логически определить расположение всех мин.

### Игровое поле и основные элементы

Пусть игровое поле представляет собой матрицу размера $n \times m$.

Каждая клетка поля обозначается парой индексов $(i, j)$, где $1 \leq i \leq n,\ 1 \leq j \leq m$.

Для каждой клетки введём булеву переменную:

$$
x_{ij} =
\begin{cases}
1, & \text{если в клетке } (i, j) \text{ находится мина;} \\
0, & \text{если клетка пуста.}
\end{cases}
$$

### Соседство клеток

Каждая клетка имеет множество соседей $N(i, j)$, включающее до восьми клеток вокруг неё (по горизонтали, вертикали и диагонали):

$$
N(i, j) = \\\{(p, q) \mid |p - i| \leq 1, \ |q - j| \leq 1, \ (p, q) \neq (i, j)\\\}
$$

### Числовые подсказки

Если клетка не содержит мины и открыта, на ней отображается **число** $a_{ij}$, которое показывает количество мин в соседних клетках. Формально:

$$
a_{ij} = \sum_{(p, q) \in N(i, j)} x_{pq}
$$

Таким образом, каждая открытая клетка задаёт **ограничение** (линейное уравнение) на булевы переменные, описывающие соседние клетки.

### Цель и математическая формализация игры

Известными считаются:
- размеры игрового поля $n \times m$;
- множество открытых клеток $S \subseteq \\\{1, \ldots, n\\\} \times \\\{1, \ldots, m\\\}$;
- значения чисел $a_{ij}$ для всех $(i, j) \in S$.

Неизвестными остаются:
- булевы переменные $x_{ij} \in \\\{0, 1\\\}$, определяющие, где именно находятся мины.

**Задача игрока** – на основе известных чисел $a_{ij}$ определить такое распределение мин, при котором все подсказки согласованы с конфигурацией поля.

Пусть $X = \\\{x_{ij}\\\},$ тогда математическая задача **«Сапёра»** сводится к поиску булевой матрицы, удовлетворяющей системе линейных равенств, заданной известными числами $a_{ij}$ для всех открытых клеток:

$$
\exists X \in \\\{0, 1\\\}^{n \times m} \enspace : \enspace \forall (i, j) \in S \Rightarrow 
\sum_{(p, q) \in N(i, j)} x_{pq} = a_{ij}
$$

### Принадлежность классу NP

Если дана матрица $X$, можно за полиномиальное время $O(nm)$ проверить каждое равенство:

$$
\sum_{(p, q) \in N(i, j)} x_{pq} = a_{ij},
$$

следовательно, $\textbf{MINESWEEPER-CONSISTENCY} \in \mathbf{NP}$.

### NP-трудность

Докажем NP-трудность сведением из задачи **3-SAT** (выполнимость булевой формулы).

Пусть дана формула:

$$
\Phi = (l_{11} \lor l_{12} \lor l_{13}) \land (l_{21} \lor l_{22} \lor l_{23}) \land \cdots \land (l_{k1} \lor l_{k2} \lor l_{k3}),
$$

где каждый литерал $l_{tj}$ – это либо переменная $x_i$, либо отрицание $\lnot x_i$.

Нужно определить, существует ли набор значений $x_i \in \\\{0, 1\\\}$, при котором $\Phi = 1$.

> ### Примечание
> Сведение будем выполнять **с помощью кодирования**. Кодирование – это способ перевести логическую задачу в игровую форму *«Сапёра»*, заменяя логические элементы формулы на соответствующие клетки и числовые подсказки.  
>
> В задаче **3-SAT** у нас есть три вида логических элементов:  
> - **переменные** $x_i$, которые могут быть истинными (1) или ложными (0);  
> - **отрицания** $\lnot x_i$, которые меняют значение переменной на противоположное;  
> - **скобки** (логическое “ИЛИ”), например $(x_1 \lor \lnot x_2 \lor x_3)$,  
>   которые означают, что хотя бы одно из трёх значений должно быть истинным.  
>
> Чтобы свести **3-SAT** к задаче *«Сапёра»*, мы построим минное поле, где:  
> - переменные будут представлены клетками;  
> - отрицания – противоположными клетками;  
> - а логические скобки – открытыми клетками с числами, задающими ограничения на количество мин вокруг.  
>
> Таким образом, логическая формула **3-SAT** будет выражена в виде системы равенств, аналогичных правилам игры *«Сапёр»*.

**Кодирование переменной (a)**

Каждая переменная $x_i$ может быть **истинной (1)** или **ложной (0)**. Чтобы отразить это на минном поле, создаём две соседние клетки:

$$
v_i^{T}, \quad v_i^{F}
$$

где:

- $v_i^{T}$ – клетка, означающая *«переменная истинна»*;  
- $v_i^{F}$ – клетка, означающая *«переменная ложна»*.

Между ними ставим открытую клетку с числом 1, что задаёт равенство:

$$
x(v_i^{T}) + x(v_i^{F}) = 1
$$

Это значит, что **ровно одна** из двух клеток заминирована.

***Интерпретация:***

$$
x_i = 1 \Leftrightarrow x(v_i^{T}) = 1, 
\qquad
x_i = 0 \Leftrightarrow x(v_i^{F}) = 1
$$

**Кодирование отрицания (b)**

Если в формуле встречается отрицание $\lnot x_i$, то вместо клетки $v_i^{T}$ используем клетку $v_i^{F}$.  

**Кодирование логического выражения $(a \lor b \lor c)$ (c)**

Это выражение означает, что хотя бы одно из трёх значений равно 1. Берём три клетки, соответствующие этим переменным (или их отрицаниям):

$$
a, \quad b, \quad c
$$

Добавляем рядом **открытую клетку** с числом 2 и делаем так, чтобы её соседями были именно эти три клетки:

$$
N(r) = \{a, b, c\}
$$

Тогда для клетки $r$ выполняется равенство:

$$
x(a) + x(b) + x(c) = 2
$$

Эта подсказка выполняется только в том случае, если хотя бы одна из клеток $a, b, c$ содержит мину, то есть хотя бы одно значение истинно. Таким образом, она эквивалентна логическому “ИЛИ”.

**Корректность сведения**

***(⇒) Прямое направление:***

Пусть формула $\Phi$ выполнима. Тогда существует набор значений $x_i \in \\\{0, 1\\\}$, при котором каждая скобка $(a \lor b \lor c)$ истинна. Положим:

$$
x(v_i^{T}) = x_i, 
\qquad 
x(v_i^{F}) = 1 - x_i
$$

Все равенства для переменных выполняются:

$$
x(v_i^{T}) + x(v_i^{F}) = 1
$$

Для каждой тройки клеток $(a, b, c)$ из формулы хотя бы одно значение равно 1, следовательно, выполняется равенство:

$$
x(a) + x(b) + x(c) = 2
$$

Значит, все подсказки $a_{ij}$ согласованы с конфигурацией мин. Следовательно, существует корректная расстановка мин, и построенное поле имеет решение.

***(⇐) Обратное направление***

Пусть существует корректная расстановка мин $X = \{x_{ij}\}$. Тогда для каждой переменной выполняется:

$$
x(v_i^{T}) + x(v_i^{F}) = 1
$$

Это означает, что ровно одна из клеток заминирована. Определим:

$$
x_i = x(v_i^{T})
$$

Подставим эти значения в исходную формулу. Для каждой тройки клеток $(a, b, c)$ выполняется:

$$
x(a) + x(b) + x(c) = 2,
$$

а значит, хотя бы одно значение равно 1. Следовательно, выражение $(a \lor b \lor c)$ истинно, и вся формула $\Phi$ выполнима.

**Оценка сложности**

Каждая переменная и каждое выражение добавляют фиксированное число клеток и подсказок, поэтому размер поля растёт линейно:

$$
O(n + k).
$$

Построение выполняется за полиномиальное время.

### Итог

Мы показали:
1. $\textbf{MINESWEEPER-CONSISTENCY} \in \mathbf{NP}$;
2. $\textbf{3-SAT} \leq_{p} \textbf{MINESWEEPER-CONSISTENCY}$.

Следовательно: MINESWEEPER-CONSISTENCY – NP-полная.


